\documentclass[12pt]{scrartcl}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage[default]{opensans}
\usepackage{sfmath} % sans font also for math
 \usepackage[binary-units = true]{siunitx}

% defining the paper layout that no text overlaps with the header
\usepackage[
  top=35mm,
  headheight=25mm,
  headsep=3mm,
  bottom=30mm,
  left=25mm,
  right=25mm
]{geometry}

\usepackage{latexsym}
\usepackage[centertags]{amsmath}
\usepackage{amssymb}

\graphicspath{{figures/}}
% custom header and footpage
\usepackage{scrpage2}
\pagestyle{scrheadings} % you have to set the custom layout
% Head
\ihead{M4.3} % left head
%\chead{}
\ohead{\includegraphics[height=25mm]{figures/EUCALL.png}}
% Foot
\ifoot{\includegraphics[height=13.4mm]{figures/EU.png}} % left foot
\cfoot{%
  \begin{minipage}{100mm}%
    \begin{scriptsize}%
      \normalfont{This project has received funding from the}
      \textit{European Union’s Horizon 2020 research and innovation programme}
      \normalfont{under grant agreement No 654220.}
    \end{scriptsize}%
  \end{minipage}%
} % center foot
\ofoot{\thepage} % right foot

\usepackage{booktabs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%   BIBLIOGRAPHY SETTINGS                     %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[bibstyle=nature,sorting=none,=maxnames=1000,eprint=false,
defernumbers=true, backend=biber]{biblatex}
\usepackage{hyperref}

\renewcommand*\finalnamedelim{, and\addspace}
\DeclareNameAlias{sortname}{last-first}
\renewcommand{\newunitpunct}{, }

\AtEveryBibitem{%
  \clearfield{day}%
  \clearfield{month}%
  \clearfield{endday}%
  \clearfield{endmonth}%
  \clearfield{issn}%
  \clearfield{issue}%
}
%convert titles to hyperlinks using doi
\ExecuteBibliographyOptions{doi=false} \newbibmacro{string+doi}[1]{%
  \iffieldundef{doi}{#1}{\href{http://dx.doi.org/\thefield{doi}}{#1}}}
  \DeclareFieldFormat*{title}{\usebibmacro{string+doi}{\mkbibemph{#1}}}

\addbibresource{references.bib}
\addbibresource{aux.bib}
\addbibresource{contributions/HPL/sample.bib}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END BIBLIOGRAPHY SETTINGS                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% sophisticated linking of references in the pdf and setting some options
\usepackage{url}                                                  % for correct typesettings of URLs
\usepackage{hyperref}                                             % for sophisticated linking of urls, dois, pictures, tables, etc.
\hypersetup{
    unicode=true,                                                 % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=true,                                              % show Acrobat’s toolbar?
    pdfmenubar=true,                                              % show Acrobat’s menu?
    pdffitwindow=false,                                           % window fit to page when opened
    pdftitle={M4.3: Simulations interoperable},                   % title
    pdfauthor={C. Fortmann-Grote},                                % author
    pdfsubject={EUCALL WP4 (SIMEX) Milestone 4.3},                % subject of the document
    pdfcreator={pdflatex},                                        % creator of the document
    pdfkeywords={EUCALL, SIMEX, simulations},                     % list of keywords
    pdfnewwindow=true,                                           % links in new PDF window
    colorlinks=true,                                             % false: boxed links; true: colored links
    linkcolor=blue,                                              % color of internal links (change box color with linkbordercolor)
    citecolor=blue,                                              % color of links to bibliography
    filecolor=blue,                                              % color of file links
    urlcolor=blue                                                % color of external links
}

% Zeilenabstand
\renewcommand{\baselinestretch}{1.2}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END BIBLIOGRAPHY SETTINGS                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\makeatletter
\begin{titlepage}
\thispagestyle{scrheadings}
\begin{center}
  $~$\\
  \vspace{2cm}
  \Huge{\textbf{WP 4 -- SIMEX\\[1cm]
    Milestone M4.3: Demonstration of interoperability of simulations%
  }}\\
  \vspace{2cm}
  \large{Carsten Fortmann-Grote, Alexander Andreev, Ashutosh Sharma, Richard
    Briggs, Jan-Philipp Burchert, Marco Garten, Axel Huebl, Alexander Grund,
  Thomas Kluge, Sergey Yakubov, Michael Bussmann, and Adrian P. Mancuso}
  \vspace{1cm}
  \date{\today}
\end{center}
\vfill%
\includegraphics[width=\textwidth]{figures/PartnerLogos_2017}
\normalfont
\end{titlepage}
\makeatother
%
\tableofcontents
%
\section{Summary}\label{sec:summary}
\textbf{Milestone M4.3} (as detailed in \textbf{Task 4.2.2}) of the SIMEX
workpackage in EUCALL is delivery of interoperable simulations
(\textbf{Deliverable D4.3}) with documented examples. We have chosen five
applications to demonstrate the interoperability of our simulation codesThe examples are
\begin{enumerate}
  \item Simulation of diffraction of coherent x--rays delivered by an X-ray
    Free--Electron Laser from high energy density matter created by short--pulse
    laser matter interaction (as detailed in Deliverable D4.1)
  \item Simulation of x--ray fine structure absorption spectroscopy (XAFS) from long--pulse laser
    shocked warm dense matter at the synchrotron light source ESRF (as detailed
    in Deliverable D4.2).
  \item Serial femtosecond crystallography from protein crystals
  \item X--ray Thomson Scattering from warm dense plasmas
  \item Small angle X--ray Scattering from proteins
\end{enumerate}


These examples demonstrate the functionality and interoperability of all
simulation tools as demanded in Task 4.2.2.
Table~\ref{tab:simulation_capabilities} summarizes the available simulation
modules, the interfaced backengine simulation codes, and the relevant sections
of this report and external references where example applications can be found.

\begin{table}
  \begin{center}
    \scriptsize
    \caption{Demonstrated simulation capabilities}
    \label{tab:simulation_capabilities}
  \begin{tabular}[ht]{|l|l|l|l|}
    \hline
      \textbf{Task} &
      \textbf{Simulation capability} &
      \textbf{Simulation code}     &
      \textbf{Example references}    \\
    \hline
    \hline
      \multirow{3}{*}{X--ray sources}
      & XFEL source                     & FAST/XPD              & \cite{EUCALL_SIMEX_M4.1,EUCALL_SIMEX_M4.2,Fortmann-Grote2017}     \\
      & XFEL source                     & Genesis/Ocelot        & \ref{sec:lwfa_source} \\
      & Synchrotron source              & ShadowOUI             & \ref{sec:xafs}       \\
    \hline
    \multirow{2}{*}{Beam propagation}
      & Coherent wave propagaton        & WPG/SRW               & \cite{EUCALL_SIMEX_M4.1,EUCALL_SIMEX_M4.2,Fortmann-Grote2017}     \\
      & X--ray tracing                  & ShadowOUI             & \ref{sec:xafs}       \\
    \hline
    \multirow{3}{*}{Photon--matter interaction}
      & Radiation damage to molecules   & XMDYN/XATOM           & \cite{EUCALL_SIMEX_M4.1,EUCALL_SIMEX_M4.2,Fortmann-Grote2017}     \\
      & Short--pulse optical laser      & PIConGPU              & \ref{sec:lwfa_source},\ref{sec:plasma_diffraction},\cite{EUCALL_SIMEX_D4.1}  \\
      & Long--pulse optical laser       & Esther Rad--hydro     & \ref{sec:xafs} \cite{Torchio2016}  \\
    \hline
    \multirow{5}{*}{Signal generation}
      & Nano-particle scattering        & singFEL               & \cite{EUCALL_SIMEX_M4.1,EUCALL_SIMEX_M4.2,Fortmann-Grote2017}     \\

      & Plasma diffraction              & paraTAXIS             &
      \ref{sec:plasma_diffraction},\cite{EUCALL_SIMEX_D4.1,Kluge2016,
      Garten2017.zenodo.885033}  \\
      & XAFS                            & FEFF                  & \ref{sec:xafs}
      \cite{EUCALL_SIMEX_D4.2,Torchio2016,Harmand2015,Mazevet2014}  \\
      & Plasma XRTS                     & XRTScode              & \ref{sec:xrts} \cite{Fortmann2009d}               \\
      & Nano--crystallography           & CrystFEL              & \ref{sec:protein_sfx}         \\
    \hline
  \end{tabular}
  \end{center}
\end{table}

These codes are interfaced through the simulation platform ``simex\_platform'', which,
on the one side defines a python library to facilitate setup
and execution in a canonical way, and, on the other side, defines data interfaces
and formats to facilitate the passing of simulation data generated from one
module to the next.

\section{Coherent diffraction from high energy density matter}\label{sec:plasma_diffraction}
\input{contributions/HPL/hpl}

\section{X--ray fine structure absorption spectroscopy\label{sec:xafs}}
%
We have executed the simulations outlined in Deliverable
4.2\cite{EUCALL_SIMEX_D4.2}, describing an XAFS experiment on shock compressed
solid matter. There are three areas of simulation that are considered to describe the
whole source-to-end experiment: X-ray source \& ray tracing, long pulse photon-matter
interaction, and X-ray absorption modelling. Currently, the simulations of X-ray
source/X-ray tracing and XAS modelling are standalone simulations that provide
important information for the long pulse hydrocode simulations. Information
such as X-ray beam size on sample, will influence the laser conditions that can
be accepted for hydrocode simulation (the laser spot must be larger than the
X-ray spot size).

\input{contributions/WDM/xafs}

\href{https://www.github.com/eucall-software/simex_platform/wiki/Esther-Hydrocode-Tutorial}{A
documented example workflow} is provided to demonstrate the usability of the
radiation--hydrodynamics simulation capabilities in \textit{simex\_platform}. It
shows how to optimize the target geometry (i.e. the thickness of the ablator
material) to maximize the data output, making use of the openPMD metadata
standard to facilitate transferrability among involved simulation codes and
data analysis and visualisation tools.

\section{Plasma X--ray Thomson Scattering\label{sec:xrts}}
TODO CFG
%
\section{Coherent diffraction from protein nano--crystals\label{sec:protein_sfx}}
In an
\href{https://github.com/eucall-software/simex_platform/wiki/Tutorial-on-nano-crystal-diffraction}{online
tutorial}, we demonstrate the usage of \textit{simex\_platform} to simulate
coherent diffraction of XFEL photons from nano--metre scale crystalline samples.
As in the other XFEL applications (see Sec.~\ref{sec:plasma_diffraction} and
Sec.~\ref{sec:xrts} as well as the first demonstration example in Milestone
M4.2 \cite{EUCALL_SIMEX_M4.2}), the source wavefront is queried from the
\href{https://in.xfel.eu/xpd}{XFEL Pulses Database XPD} and propagated to the
sample interaction point in the focus of the SPB--SFX instrument by means of
the coherent wavefront propagation code library WPG. Owing to the well defined
data interfaces and file format adaptors in \textit{simex\_platform} passing the
wavefront data to the crystal diffraction code is straightforward. We employ the
code \textit{pattern\_sim} which is part of the crystallography software suite
\textit{CrystFEL} \cite{White2012}, available as open source from the
\href{https://www.desy.de/~twhite/crystfel}{CrystFEL website}. The
corresponding \textit{Calculator} in \textit{simex\_platform} is the
\href{https://eucall-software.github.io/simex_platform/#SimEx.Calculators.CrystFELPhotonDiffractor.CrystFELPhotonDiffractor}{\textit{CrystFELPhotonDiffractor}}.
The \textit{CrystFELPhotonDiffractor} extracts the mean photon energy, the energy
spectrum, the beam divergence, the beam diameter, and other beam characteristics
from the wavefront data. The sample must be specified by giving a PDB code along
with information about the size of the nano--crystal, e.g. the extension in x,y,
and z directions. By default, the sample geometry is rotated in space via a
randomly chosen rotation operator to mimic the unknown orientation of the sample
in the experiment. Each simulated pattern is stored in a separate hdf5 file.
After the calculation, one master hdf5 file is generated which links to the
individual patterns and which has the same hierarchy as output generated e.g. by
the
\href{https://eucall-software.github.io/simex_platform/#SimEx.Calculators.SingFELPhotonDiffractor.SingFELPhotonDiffractor}{\textit{SingFELPhotonDiffractor}}
for single particle coherent diffraction. This in turn ensures that the same
analysis tools (e.g.
\href{https://eucall-software.github.io/simex_platform/#SimEx.Analysis.DiffractionAnalysis.DiffractionAnalysis}{\textit{DiffractionAnalysis}})
can be applied to crystal diffraction data and to single partice diffraction
data.

%
\section{Laser--wakefield driven FEL source}\label{sec:lwfa_source}
\input{contributions/LWFA-FEL/lwfa-fel}

%Simulations of compact coherent x--ray sources based on the mechanism of
%electron laser wakefield acceleration (LWFA) couple particle--in--cell
%simulations to an FEL code. In our case, we use the PIC code \textit{PIConGPU}
%and the Genesis FEL code. \textit{PIConGPU} writes the particle and field data
%into a hdf5 file using the openPMD \cite{Huebl2017} metadata standard. A file format conversion utility, which is part of
%\textit{simex\_platform} converts the PIC output to an electron distribution
%file (extension .dist) readable by \textit{Genesis}.

\printbibliography[notkeyword=report, notkeyword=zenodo, title={Journal articles}]
%
\printbibliography[keyword=eucall, keyword=report, title={EUCALL Reports}]
%
\printbibliography[keyword=zenodo, title={EUCALL Data Repository Depositions}]

\end{document}


